const util = require('util');
const mqtt = require('mqtt');
const assert = require('assert');
const NodeMQTTEmitter = require('../lib/node-mqtt-emitter');
const mqttEmitterRPC = require('../lib/mqtt-emitter-rpc');
const Speech2TextTask = require('../tasks/speech2text');

var debuglog = util.debuglog('test');
var mqttClient = mqtt.connect('mqtt://localhost');
var mqttEmitter = NodeMQTTEmitter(mqttClient);
var app = { mqttEmitter };


describe('speech2text spec', function () {
  before(function () {
    mqttEmitter.on('speech2text/do/request', function (payload) {
      var obj = JSON.parse(payload.toString());
      debuglog('received request: %j', obj);
      if (obj.file !== 'vfile') return;
      mqttEmitter.publish('speech2text/do/reply', JSON.stringify({
        correlationId: obj.correlationId,
        file: 'vfile2',
        text: 'vtext2'
      }));
      debuglog('published');
    });
  });
  after(function () {
    mqttEmitter.removeAllListeners('speech2text/do/request');
  });
  it('should be ok', function (done) {
    var task = new Speech2TextTask();
    task.app = app;
    task.run({
      file: 'vfile',
      pipe: 'vpipe',
      parameter: 'vparameter'
    }, function (err, results) {
      if (err) return done(err);
      assert(results.file === 'vfile2');
      assert(results.text === 'vtext2');
      done()
    });
  });
});
